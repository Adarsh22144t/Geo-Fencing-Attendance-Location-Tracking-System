<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üìç Geo-Fencing Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="text-center mb-4">üìç Geo-Fencing Attendance System</h2>

    <!-- Live Location Display -->
    <div class="text-center mb-3">
        <p id="liveLocation" class="fw-bold text-primary">Fetching live location...</p>
    </div>

    <div class="card shadow p-4">
        <h5 class="mb-3">Employee Check-In</h5>

        <form id="attendanceForm">
            <div class="mb-3">
                <label class="form-label">Employee ID</label>
                <input type="text" class="form-control" id="emp_id" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Employee Name</label>
                <input type="text" class="form-control" id="emp_name" required>
            </div>

            <button type="submit" class="btn btn-primary w-100">Mark Attendance</button>
        </form>

        <div id="statusBox" class="alert mt-4 d-none"></div>
    </div>

    <p class="text-center mt-4">
        <a href="/admin" target="_blank">Go to Admin Dashboard ‚Üí</a>
    </p>
</div>

<script>
// ‚ñà‚ñà‚ñà‚ñà LIVE LOCATION DISPLAY ‚ñà‚ñà‚ñà‚ñà
document.addEventListener("DOMContentLoaded", () => {
    const liveLocEl = document.getElementById("liveLocation");

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude.toFixed(6);
                const lng = pos.coords.longitude.toFixed(6);
                liveLocEl.textContent = `üìç Live Location: ${lat}, ${lng}`;
                console.log("Live Location:", lat, lng);
            },
            () => {
                liveLocEl.textContent = "‚ö† Unable to fetch live location.";
            }
        );
    } else {
        liveLocEl.textContent = "‚ùå Geolocation not supported.";
    }
});

// ‚ñà‚ñà‚ñà‚ñà ATTENDANCE SUBMISSION ‚ñà‚ñà‚ñà‚ñà
document.getElementById("attendanceForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const empId = document.getElementById("emp_id").value.trim();
    const empName = document.getElementById("emp_name").value.trim();
    const statusBox = document.getElementById("statusBox");

    if (!empId || !empName) {
        statusBox.className = "alert alert-danger mt-4";
        statusBox.textContent = "Please enter Employee ID and Name.";
        statusBox.classList.remove("d-none");
        return;
    }

    if (!navigator.geolocation) {
        statusBox.className = "alert alert-danger mt-4";
        statusBox.textContent = "Geolocation is not supported by your browser.";
        statusBox.classList.remove("d-none");
        return;
    }

    statusBox.className = "alert alert-info mt-4";
    statusBox.textContent = "Getting your location‚Ä¶ Please wait.";
    statusBox.classList.remove("d-none");

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            fetch("/mark", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    emp_id: empId,
                    emp_name: empName,
                    lat: lat,
                    lng: lng
                })
            })
            .then((res) => res.json())
            .then((data) => {
                console.log("Server response:", data);

                let display =
                    (data.inside ? "‚úÖ INSIDE GEOFENCE\n" : "‚ùå OUTSIDE GEOFENCE\n") +
                    `Distance: ${data.distance_m}m`;

                statusBox.className = data.inside
                    ? "alert alert-success mt-4"
                    : "alert alert-warning mt-4";

                statusBox.textContent = display;
            })
            .catch(() => {
                statusBox.className = "alert alert-danger mt-4";
                statusBox.textContent = "Error contacting server.";
            });
        }
    );
});
</script>

</body>
</html>
